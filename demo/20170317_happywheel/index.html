<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title></title>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,user-scalable=no" name="viewport" />
    <link href="css/main.css" rel="stylesheet" />

</head>
<body class="lottery-page">

    <div class="title">

    </div>

    <div class="des">
        本级还有
        <span><b>2</b></span>
        次抽奖机会
    </div>

    <div class="dish">
        <div class="rotate"></div>
        <div class="bg"></div>
        <div class="arrows"></div>
    </div>

    <div class="listshow">
        <dl>
            <dt>今日奖学金运气王</dt>
            <dd>
                <div class="win">
                    <ul>
                        <li>没有数据</li>
                    </ul>
                </div>
               
            </dd>
        </dl>
    </div>
    
    <a class="ad" href="http://math.shendupeiban.com/vipad/"></a>

    <div class="preloader-indicator-modal">
        <div class="preloader"></div>

    </div>

    <script src="js/common.js"></script>
    <script src="js/common_mobile.js"></script>
    <script>
        "use strict";

        function transmitData(d) {
            if(typeof d ==='string'){
                d = JSON.parse(d);
            }

            var dataNum = d.chances,// 抽奖次数
                dataLevel = d.level,// 级别
                dataNoLotter = d.left == 0// 是否可以抽奖
            ;

            var imgsData = [
                'css/imgs/dish' + dataLevel + '.png'
                , 'css/imgs/dish-bg.png'
                , 'css/imgs/ico.png'
                , 'css/imgs/start.png'
            ];

            c.imgsLoad(imgsData, function () {
                // 图片加载完成
                fnInit();
            });

            function fnInit() {
                var
                prizeId = 0,

                prizes = {},

                lotteryNum = dataNum,// 抽奖次数

                isSuccess=false,//抽奖是否成功
                isRun = false,
                deg = 0,

                cssTransform = c.getCssName('transform'),

                flickerTime = 600,

                callName = 'Lottery',

                eStartBtn,
                eRotate,
                eFlicker,
                eNum, eLoading,eGoVip;

                assignDoms();

                flicker();

                for (var i = 0, count = 6; i < count; i++) {
                    prizes[i] = {
                        0: i * 360 / count,
                        1: 360 / count
                    };
                }

                c.click(eStartBtn, function () {
                    if (isRun === false) {
                        if (dataNoLotter && lotteryNum > 0) {
                            isRun = true;
                            flickerTime = 200;
                            startRotate();
                        }

                        // 开始抽奖、次数用完
                        c.deviceCallback([callName, 'getLottery'], 'getLottery:0');
                    }
                });

                scrollAnime();

                c.removeElement(eLoading);

                c.click(eGoVip, function () {
                    c.deviceCallback([callName, 'openVipUrl'], 'openVipUrl:0');// 不带参
                });

                function startRotate() {
                    var i = 0, len = 200, halfLen = len / 2
                    , prev = 0, v, isFinish = false

                    , turnNum=120

                    , goalDeg = 900;

                    loop();

                    // 返回中奖值
                    window.priceResult = function (num) {
                        if (num>0) {
                            prizeId = num - 1;
                            isSuccess = true;
                        }
                        else {
                            prizeId = 1;
                            isSuccess = false;
                        }

                        isFinish = true;
                    };

                    function loop() {

                        requestAnimationFrame(function () {

                            i++;
//                            console.log(isFinish === false);
                            if ((i > halfLen && isFinish === false) || turnNum>0) {
//                            if(i > halfLen ){
                                i = halfLen;
                            }

                            if (isFinish && i > halfLen) {
                                goalDegUpdate();
                                v = easeInOutQuad(null, i, 0, goalDeg, len);
                                prev = easeInOutQuad(null, i - 1, 0, goalDeg, len);

                                deg += v - prev;
                            }
                            else {
                                v = easeInOutQuad(null, i, 0, goalDeg, len);
                                prev = easeInOutQuad(null, i - 1, 0, goalDeg, len);

                                deg += v - prev;
                            }

                            eRotate.style[cssTransform] = 'rotate3d(0,0,1,' + deg + 'deg)';

                            turnNum--;

                            if (i < len) loop();
                            else endFn();

                        });
                    }

                    function goalDegUpdate() {

                        if (goalDegUpdate.noFirst === undefined) {

                            var rDeg = deg - ~~(deg / 360) * 360,
                                easeDeg = (360 + prizes[prizeId][0] - rDeg + 15);

                            easeDeg %= 360;

                            if (easeDeg < 226) {
                                easeDeg += 360;
                            }

                            goalDeg = easeDeg * 2;

                            goalDegUpdate.noFirst = 1;
                        }

                    }

                    function easeInOutQuad(x, t, b, c, d) {
                        if ((t /= d / 2) < 1) return c / 2 * t * t + b;
                        return -c / 2 * ((--t) * (t - 2) - 1) + b;
                    };
                }

                // 抽奖结束
                function endFn() {
                    
                    c.deviceCallback([callName, 'showResult'], 'showResult:0');// 不带参

                    isRun = false;

                    flickerTime = 600;

                    if (isSuccess) {
                        lotteryNum--;

                        eNum.innerHTML = lotteryNum;
                    }
                }

                function flicker() {
                    var is;

                    loopFn();

                    function loopFn() {
                        if (is) { eFlicker.style[cssTransform] = 'rotate3d(0,0,1,35deg)'; is = 0; }
                        else { eFlicker.style[cssTransform] = 'rotate3d(0,0,1,0deg)'; is = 1; }
                        setTimeout(loopFn, flickerTime);
                    }
                }

                function assignDoms() {
                    var eBox = document.querySelector('.lottery-page'),
                        eDish = eBox.querySelector('.dish'),
                        child;

                    child = eDish.children;

                    eStartBtn = child[2];
                    eRotate = child[0];
                    eFlicker = child[1];

                    eLoading = c.filtrateElementsByClassName('preloader-indicator-modal', eBox.children)[0];
                    eGoVip = c.filtrateElementsByClassName('ad', eBox.children)[0];

                    eNum = document.querySelector('.des b');

                    /// 
                    eRotate.style.backgroundImage = 'url(' + imgsData[0] + ')';
                    eNum.innerHTML = lotteryNum;
                }

                // 自动滚动效果
                function scrollAnime() {
                    var
                       eShowWin = document.querySelector('.listshow .win')
                        , eUl = eShowWin.children[0]
                        , winHeight

                        , duration
                        , eStyle
                        , html='';

                    d.nominates.forEach(function (n) {
                        html += '<li>' + n.name + '<br/>' + n.prize + '<br/></li>';
                    });

                    if (html === '') {
                        html = '今日运气王暂未诞生，快试试你的运气吧！';
                    }
                    eUl.innerHTML = html;

                    winHeight = eUl.clientHeight;
                    if (winHeight <= eShowWin.clientHeight) {
                        return;
                    }

                    // 每秒滚动20px。计算需要多少秒
                    duration = (winHeight / 20).toFixed(2);

                    eStyle = document.createElement('style');

                    eStyle.innerHTML = '.lottery-page .listshow ul {\
-webkit-animation:a ' + duration + 's infinite linear normal;\
animation:a ' + duration + 's infinite linear normal;\
}\
@keyframes a{0%{\
transform:translate3d(0,0,0);}100%{\
transform:translate3d(0,-' + winHeight + 'px,0);}}\
@-webkit-keyframes a{0%{\
-webkit-transform:translate3d(0,0,0);\
-webkit-transform:translate3d(0,-' + winHeight + 'px,0);}}';

                    eShowWin.innerHTML += eShowWin.innerHTML;

                    document.body.appendChild(eStyle);
                }
            }
        }

        

    </script>
    <script src="data_.js"></script>
</body>

</html>
